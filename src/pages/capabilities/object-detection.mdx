# Object Detection üöß

import { Callout } from 'nextra/components'
import { Steps } from 'nextra/components'
import { Tabs } from 'nextra/components'

<Callout type="info">
  Detect and locate objects in images with high precision using Moondream's object detection capabilities.
</Callout>

## Overview

Moondream's object detection feature offers:
- Precise object localization
- Confidence scores for detections
- Support for multiple object classes
- Bounding box coordinates

## Implementation Guide

<Steps>
### 1. Download Model
<Tabs items={['Python (pip)', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    import os
    import requests
    import gzip
    from tqdm import tqdm

    # Model URLs dictionary
    MODEL_URLS = {
        'int8': "https://huggingface.co/vikhyatk/moondream2/resolve/client/moondream-latest-int8.bin.gz?download=true",
        'fp16': "https://huggingface.co/vikhyatk/moondream2/resolve/client/moondream-latest-f16.bin.gz?download=true",
        'int4': "https://huggingface.co/vikhyatk/moondream2/resolve/client/moondream-latest-int4.bin.gz?download=true",
        '0.5b-int8': "https://huggingface.co/vikhyatk/moondream2/resolve/onnx/moondream-0_5b-int8.bin.gz?download=true",
        '0.5b-int4': "https://huggingface.co/vikhyatk/moondream2/resolve/onnx/moondream-0_5b-int4.bin.gz?download=true"
    }

    def download_model(variant='0.5b-int8', save_dir="models"):
        """Download and extract model weights using wget-style direct extraction.
        
        Args:
            variant (str): Model variant to download. Options:
                - 'int8': Latest INT8 model (2.09 GB)
                - 'fp16': Latest FP16 model (3.74 GB)
                - 'int4': Latest INT4 model (1.52 GB)
                - '0.5b-int8': Lightweight INT8 model (613 MB)
                - '0.5b-int4': Lightweight INT4 model (479 MB)
            save_dir (str): Directory to save the model
        """
        if variant not in MODEL_URLS:
            raise ValueError(f"Invalid variant. Choose from: {list(MODEL_URLS.keys())}")
        
        os.makedirs(save_dir, exist_ok=True)
        output_path = os.path.join(save_dir, f"moondream-{variant.replace('0.5b-', '0_5b-')}.bin")
        
        # Check if model already exists
        if os.path.exists(output_path):
            print(f"‚úÖ Model already exists at: {output_path}")
            return output_path
        
        # Download and extract in one step
        print(f"üì• Downloading and extracting {variant} model...")
        print("‚ö†Ô∏è Download time varies by model size and connection speed...")
        response = requests.get(MODEL_URLS[variant], stream=True)
        total_size = int(response.headers.get('content-length', 0))
        
        with open(output_path, 'wb') as f_out:
            with gzip.GzipFile(fileobj=response.raw, mode='rb') as f_gz:
                with tqdm(total=total_size, unit='iB', unit_scale=True) as pbar:
                    while True:
                        chunk = f_gz.read(1024*1024)
                        if not chunk:
                            break
                        f_out.write(chunk)
                        pbar.update(len(chunk))
        
        print(f"‚úÖ Model ready at: {output_path}")
        return output_path

    # Choose and download model variant
    # Note: Object detection requires the 2B model (int8, fp16, or int4)
    variant = 'int8'  # Using 2B INT8 model for detection
    model_path = download_model(variant=variant)
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    // Coming soon
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Coming soon
    ```
  </Tabs.Tab>
</Tabs>

### 2. Initialize Model
<Tabs items={['Python (pip)', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    import moondream as md
    from PIL import Image, ImageDraw

    # Initialize model with path to weights
    model = md.VL(model_path)
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    // Coming soon
    import { MoondreamAPI } from 'moondream';
    
    const model = new MoondreamAPI();
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Coming soon
    import { MoondreamAPI } from 'moondream';
    
    const model = new MoondreamAPI();
    ```
  </Tabs.Tab>
</Tabs>

### 3. Load Image
<Tabs items={['Python (pip)', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    # Load and encode image
    image = Image.open("cat.jpg")
    encoded_image = model.encode_image(image)
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    // Coming soon
    const image = await loadImage("cat.jpg");
    const encodedImage = await model.encodeImage(image);
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Coming soon
    const image = await loadImage("cat.jpg");
    const encodedImage = await model.encodeImage(image);
    ```
  </Tabs.Tab>
</Tabs>

### 4. Detect Objects
<Tabs items={['Python (pip)', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    # Detect specific features
    detections = model.detect(image, "cat eyes")
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    // Coming soon
    const detections = await model.detect(encodedImage, "cat eyes");
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Coming soon
    const detections = await model.detect(encodedImage, "cat eyes");
    ```
  </Tabs.Tab>
</Tabs>

### 5. Visualize Results
<Tabs items={['Python (pip)', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    # Draw bounding boxes
    draw = ImageDraw.Draw(image)
    for detection in detections:
        # Get coordinates (normalized between 0 and 1)
        x_min = detection["x_min"] * image.width
        y_min = detection["y_min"] * image.height
        x_max = detection["x_max"] * image.width
        y_max = detection["y_max"] * image.height
        
        # Draw rectangle
        draw.rectangle(
            [x_min, y_min, x_max, y_max],
            outline="red",
            width=3
        )

    # Display or save the result
    image.show()  # or image.save("output.jpg")
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    // Coming soon
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Draw detections
    for (const detection of detections) {
        const { x_min, y_min, x_max, y_max } = detection;
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 3;
        ctx.strokeRect(x_min * width, y_min * height, 
                      (x_max - x_min) * width, 
                      (y_max - y_min) * height);
    }
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    // Coming soon
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Draw detections
    for (const detection of detections) {
        const { x_min, y_min, x_max, y_max } = detection;
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 3;
        ctx.strokeRect(x_min * width, y_min * height, 
                      (x_max - x_min) * width, 
                      (y_max - y_min) * height);
    }
    ```
  </Tabs.Tab>
</Tabs>
</Steps>

## Best Practices

<Callout type="warning">
  For best results, ensure images are clear and well-lit. Consider using confidence thresholds to filter detections.
</Callout>

- Set appropriate confidence thresholds
- Process high-resolution images
- Consider object size and visibility
- Handle multiple detections appropriately

## Example Use Cases

1. **Security & Surveillance**
   - Person detection
   - Object tracking
   - Intrusion detection

2. **Retail Analytics**
   - Product detection
   - Shelf monitoring
   - Customer behavior analysis

3. **Smart Cities**
   - Vehicle detection
   - Pedestrian counting
   - Traffic monitoring

## Error Handling

<Tabs items={['Python', 'JavaScript', 'TypeScript']}>
  <Tabs.Tab>
    ```python
    try:
        response = await api.detect_object(
            image_url="https://example.com/image.jpg",
            object="person"
        )
    except InvalidImageError:
        print("Invalid image URL or format")
    except APIError as e:
        print(f"API error: {str(e)}")
    except Exception as e:
        print(f"Unexpected error: {str(e)}")
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    try {
      const response = await api.detectObject({
        imageUrl: "https://example.com/image.jpg",
        object: "person"
      });
    } catch (error) {
      if (error instanceof InvalidImageError) {
        console.error("Invalid image URL or format");
      } else if (error instanceof APIError) {
        console.error(`API error: ${error.message}`);
      } else {
        console.error(`Unexpected error: ${error.message}`);
      }
    }
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```typescript
    try {
      const response = await api.detectObject({
        imageUrl: "https://example.com/image.jpg",
        object: "person"
      });
    } catch (error) {
      if (error instanceof InvalidImageError) {
        console.error("Invalid image URL or format");
      } else if (error instanceof APIError) {
        console.error(`API error: ${error.message}`);
      } else {
        console.error(`Unexpected error: ${error.message}`);
      }
    }
    ```
  </Tabs.Tab>
</Tabs>

## Related Resources

- [Getting Started Guide](/docs/getting-started)
- [API Reference](/docs/api-reference)
- [Example Projects](/docs/examples) 