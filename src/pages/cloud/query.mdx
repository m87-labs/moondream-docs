import { Tabs } from 'nextra/components'
import { Callout } from 'nextra/components'
import Head from 'next/head'

# Visual Question Answering API

<Head>
  <meta name="color-scheme" content="light" />
</Head>

Ask questions about images and get natural language answers.

## API Specification

### Request Model
~~~python filename="models.py"
class VqaRequest(BaseModel):
    image_url: str
    question: str
    stream: Optional[bool] = False
~~~

### Response Model
<Tabs items={['Non-Streaming', 'Streaming']}>
  <Tabs.Tab>
~~~python filename="response.py"
class VqaResponse(BaseModel):
    result: str  # The answer to the question
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~python
{
    'chunk': str,  # token from stream
    'completed': bool
}
~~~
  </Tabs.Tab>
</Tabs>

### Example Response
```python
# Non-streaming response
{
    "result": "The main color in this image is blue."
}

# Streaming response chunks
{"chunk": "The ", "completed": false}
{"chunk": "main ", "completed": false}
{"chunk": "color ", "completed": false}
{"chunk": "is ", "completed": false}
{"chunk": "blue", "completed": false}
{"chunk": ".", "completed": true}
```

## Example Usage

<Tabs items={['cURL', 'Python', 'Node.js', 'Fetch', 'Axios']}>
  <Tabs.Tab>
~~~bash filename="query.sh"
# Convert image to base64
IMAGE_BASE64=$(base64 -i image.jpg)

# Make API request
curl -X POST https://playground2.servers.moondream.ai/v1/query \
  -H "Content-Type: application/json" \
  -H "X-Moondream-Auth: $MOONDREAM_API_KEY" \
  -d "{
    \"image_url\": \"data:image/jpeg;base64,$IMAGE_BASE64\",
    \"question\": \"What is the main color in this image?\",
    \"stream\": false
  }"
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~python filename="query.py" {3-4,14,33-34} showLineNumbers
import os
from urllib.request import Request, urlopen
import json
import base64

# Load image file and convert to base64
def get_base64_image(image_path):
    with open(image_path, "rb") as f:
        return base64.b64encode(f.read()).decode()

# Get API key from environment variable
api_key = os.getenv("MOONDREAM_API_KEY")
if not api_key:
    raise ValueError("Please set MOONDREAM_API_KEY environment variable")

# Prepare request
image_base64 = get_base64_image("image.jpg")
data = {
    "image_url": f"data:image/jpeg;base64,{image_base64}",
    "question": "What is the main color in this image?",
    "stream": False
}

# Set up request headers
headers = {
    "X-Moondream-Auth": api_key,
    "Content-Type": "application/json"
}

# Make request using standard library
req = Request(
    "https://playground2.servers.moondream.ai/v1/query",
    data=json.dumps(data).encode(),
    headers=headers,
    method="POST"
)

# Send request and handle response
try:
    with urlopen(req) as response:
        result = json.loads(response.read())
        print(f"Answer: {result['result']}")
except Exception as e:
    print(f"Error making request: {str(e)}")
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~typescript filename="query.ts" {3-4,14,33-34} showLineNumbers
import { readFileSync } from 'fs';
import { request } from 'https';

// Load and convert image to base64
function getBase64Image(imagePath: string): string {
  const imageBuffer = readFileSync(imagePath);
  return imageBuffer.toString('base64');
}

// Get API key from environment
const apiKey = process.env.MOONDREAM_API_KEY;
if (!apiKey) {
  throw new Error('Please set MOONDREAM_API_KEY environment variable');
}

// Prepare request data
const imageBase64 = getBase64Image('image.jpg');
const data = {
  image_url: `data:image/jpeg;base64,${imageBase64}`,
  question: 'What is the main color in this image?',
  stream: false
};

// Set up request options
const options = {
  hostname: 'playground2.servers.moondream.ai',
  path: '/v1/query',
  method: 'POST',
  headers: {
    'X-Moondream-Auth': apiKey,
    'Content-Type': 'application/json'
  }
};

// Make request
const req = request(options, (res) => {
  let data = '';

  res.on('data', (chunk) => {
    data += chunk;
  });

  res.on('end', () => {
    try {
      const result = JSON.parse(data);
      console.log('Answer:', result.result);
    } catch (error) {
      console.error('Error parsing response:', error);
    }
  });
});

req.on('error', (error) => {
  console.error('Error making request:', error);
});

// Send request
req.write(JSON.stringify(data));
req.end();
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~javascript filename="query-fetch.js" {14,33-34} showLineNumbers
// Load and convert image to base64
async function getBase64Image(imagePath) {
  const response = await fetch(imagePath);
  const blob = await response.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

async function askQuestion() {
  try {
    const imageBase64 = await getBase64Image('image.jpg');
    
    const response = await fetch('https://playground2.servers.moondream.ai/v1/query', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Moondream-Auth': process.env.MOONDREAM_API_KEY
      },
      body: JSON.stringify({
        image_url: `data:image/jpeg;base64,${imageBase64}`,
        question: 'What is the main color in this image?',
        stream: false
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    console.log('Answer:', data.result);
  } catch (error) {
    console.error('Error making request:', error);
  }
}

askQuestion();
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~javascript filename="query-axios.js" {14,33-34} showLineNumbers
import axios from 'axios';
import fs from 'fs';

async function askQuestion() {
  try {
    // Read and convert image to base64
    const imageBuffer = fs.readFileSync('image.jpg');
    const imageBase64 = imageBuffer.toString('base64');

    const response = await axios({
      method: 'post',
      url: 'https://playground2.servers.moondream.ai/v1/query',
      headers: {
        'Content-Type': 'application/json',
        'X-Moondream-Auth': process.env.MOONDREAM_API_KEY
      },
      data: {
        image_url: `data:image/jpeg;base64,${imageBase64}`,
        question: 'What is the main color in this image?',
        stream: false
      }
    });

    console.log('Answer:', response.data.result);
  } catch (error) {
    if (error.response) {
      console.error('Error from server:', error.response.data);
    } else if (error.request) {
      console.error('No response received:', error.request);
    } else {
      console.error('Error making request:', error.message);
    }
  }
}

askQuestion();
~~~
  </Tabs.Tab>
</Tabs>

<Callout type="info">
  The examples above demonstrate different ways to interact with the API using popular libraries and tools. Each example includes proper error handling and environment variable usage. For streaming responses, see the streaming example below.
</Callout>

## Streaming Example

<Tabs items={['Python', 'Node.js']}>
  <Tabs.Tab>
~~~python filename="query_stream.py" showLineNumbers
import json
import os
import base64
from urllib.request import Request, urlopen

# Load image and convert to base64
with open("image.jpg", "rb") as f:
    image_base64 = base64.b64encode(f.read()).decode()

# Prepare request
data = {
    "image_url": f"data:image/jpeg;base64,{image_base64}",
    "question": "What is the main color in this image?",
    "stream": True
}

headers = {
    "X-Moondream-Auth": os.getenv("MOONDREAM_API_KEY"),
    "Content-Type": "application/json"
}

# Make streaming request
req = Request(
    "https://playground2.servers.moondream.ai/v1/query",
    data=json.dumps(data).encode(),
    headers=headers,
    method="POST"
)

try:
    with urlopen(req) as response:
        full_response = ""
        for line in response:
            line = line.decode().strip()
            if not line:
                continue

            if line == "[START]":
                continue
            elif line == "[DONE]":
                break

            if line.startswith("data: "):
                try:
                    chunk = json.loads(line[6:])
                    if chunk["completed"]:
                        break
                    chunk_text = chunk["chunk"]
                    full_response += chunk_text
                    print(chunk_text, end="", flush=True)
                except json.JSONDecodeError:
                    print(f"Failed to parse chunk: {line}")

    print("\nFinal response:", full_response)
except Exception as e:
    print(f"Error making streaming request: {str(e)}")
~~~
  </Tabs.Tab>
  <Tabs.Tab>
~~~typescript filename="query_stream.ts" showLineNumbers
import { readFileSync } from 'fs';
import { request } from 'https';

// Load and convert image to base64
const imageBuffer = readFileSync('image.jpg');
const imageBase64 = imageBuffer.toString('base64');

// Prepare request data
const data = {
  image_url: `data:image/jpeg;base64,${imageBase64}`,
  question: 'What is the main color in this image?',
  stream: true
};

// Set up request options
const options = {
  hostname: 'playground2.servers.moondream.ai',
  path: '/v1/query',
  method: 'POST',
  headers: {
    'X-Moondream-Auth': process.env.MOONDREAM_API_KEY,
    'Content-Type': 'application/json'
  }
};

// Make streaming request
let fullResponse = '';

const req = request(options, (res) => {
  res.on('data', (chunk) => {
    const lines = chunk.toString().split('\n');
    
    for (const line of lines) {
      if (!line.trim()) continue;
      if (line === '[START]') continue;
      if (line === '[DONE]') break;

      if (line.startsWith('data: ')) {
        try {
          const data = JSON.parse(line.slice(6));
          if (data.completed) break;
          
          const chunkText = data.chunk;
          fullResponse += chunkText;
          process.stdout.write(chunkText);
        } catch (error) {
          console.error('Failed to parse chunk:', line);
        }
      }
    }
  });

  res.on('end', () => {
    console.log('\nFinal response:', fullResponse);
  });
});

req.on('error', (error) => {
  console.error('Error making streaming request:', error);
});

req.write(JSON.stringify(data));
req.end();
~~~
  </Tabs.Tab>
</Tabs>

<Callout type="info">
  The streaming examples show how to handle server-sent events (SSE) and accumulate chunks of text as they arrive. This is useful for real-time display of model outputs.
</Callout>

---

## Next Steps

- Check out our [Examples](/cookbook/basic-usage) to see visual question answering in action with sample code and use cases
- Learn about model specifications and performance in our [Technical Specifications](/technical-specifications) guide
- Want to use moondream with Transformers? Check out our [Integration Guide](/advanced/transformers)